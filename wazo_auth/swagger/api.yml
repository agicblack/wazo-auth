swagger: '2.0'
info:
  version: '0.1'
  title: wazo-auth
  description: "Wazo's authentication service"
  contact:
    name: Wazo dev team
    url: http://wazo.community
    email: dev@wazo.community
  license:
    name: GPLv3
    url: http://www.gnu.org/licenses/gpl-3.0.html
x-xivo-port: 9497
x-xivo-name: auth
basePath: /0.1
schemes:
- https
consumes:
- application/json
produces:
- application/json
securityDefinitions:
  wazo_auth_basic:
    type: basic
  wazo_auth_token:
    type: apiKey
    name: X-Auth-Token
    in: header
paths:
  /policies:
    get:
      security:
        - wazo_auth_token: []
      produces:
        - application/json
      summary: List ACL policies
      description: '**Required ACL:** `auth.policies.read`'
      operationId: listPolicies
      tags:
        - policies
      parameters:
      - $ref: '#/parameters/order'
      - $ref: '#/parameters/direction'
      - $ref: '#/parameters/limit'
      - $ref: '#/parameters/offset'
      - $ref: '#/parameters/search'
      responses:
        '200':
          description: A list of policies
          schema:
            $ref: '#/definitions/GetPoliciesResult'
        '401':
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
    post:
      security:
        - wazo_auth_token: []
      consumes:
        - application/json
      produces:
        - application/json
      summary: Create a new ACL policy
      description: '**Required ACL:** `auth.policies.create`

        Create a new ACL policy set that can be associated to a user, an administrator, a service or a backend.
        An ACL policy is a list of ACL or ACL templates that is used to create a token'
      operationId: createPolicies
      tags:
        - policies
      parameters:
      - name: body
        in: body
        description: The policy creation parameters
        required: true
        schema:
          $ref: '#/definitions/Policy'
          required:
            - name
      responses:
        '200':
          description: The created policy's data
          schema:
            $ref: '#/definitions/PolicyResult'
        '401':
          description: Invalid data has been supplied'
          schema:
            $ref: '#/definitions/Error'
        '409':
          description: Duplicate Policy
          schema:
            $ref: '#/definitions/Error'
  /policies/{policy_uuid}:
    get:
      tags:
        - policies
      security:
      - wazo_auth_token: []
      description: '**Required ACL**: `auth.policies.{policy_uuid}.read'
      parameters:
      - $ref: '#/parameters/policy_uuid'
      summary: Retrieves the details of a policy
      responses:
        '200':
          description: "The policy's data"
          schema:
            $ref: '#/definitions/PolicyResult'
        '401':
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        '404':
          description: Policy not found
          schema:
            $ref: '#/definitions/Error'
        '500':
          description: System related error
          schema:
            $ref: '#/definitions/Error'
    delete:
      operationId: delete_policy
      tags:
        - policies
      security:
      - wazo_auth_token: []
      description: '**Required ACL**: `auth.policies.{policy_uuid}.delete`'
      parameters:
      - name: policy_uuid
        in: path
        type: string
        description: The UUID of the policy
        required: true
      summary: Delete a policy
      responses:
        '204':
          description: The policy has been removed
        '401':
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        '404':
          description: Policy not found
          schema:
            $ref: '#/definitions/Error'
        '500':
          description: System related error
          schema:
            $ref: '#/definitions/Error'
    put:
      security:
        - wazo_auth_token: []
      consumes:
        - application/json
      produces:
        - application/json
      summary: Modify an ACL policy
      description: '**Required ACL:** `auth.policies.{policy_uuid}.edit`'
      operationId: editPolicies
      tags:
        - policies
      parameters:
      - $ref: '#/parameters/policy_uuid'
      - name: body
        in: body
        description: The policy edition parameters
        required: true
        schema:
          $ref: '#/definitions/Policy'
      responses:
        '200':
          description: The modified policy's data
          schema:
            $ref: '#/definitions/PolicyResult'
        '401':
          description: Invalid data has been supplied'
          schema:
            $ref: '#/definitions/Error'
        '409':
          description: Duplicate Policy
          schema:
            $ref: '#/definitions/Error'
  /policies/{policy_uuid}/acl_templates/{acl_template}:
    delete:
      security:
        - wazo_auth_token: []
      operationId: deletePolicyACLTemplate
      tags:
        - policies
      description: '**Required ACL:** `auth.policies.{policy_uuid}.edit`'
      summary: Dissociate an ACL template from a policy
      parameters:
      - $ref: '#/parameters/policy_uuid'
      - name: acl_template
        in: path
        type: string
        description: The ACL template to removed
        required: true
      responses:
        '204':
          description: The policy has been modified
        '404':
          description: Policy or ACL template not found
          schema:
            $ref: '#/definitions/Error'
    put:
      security:
        - wazo_auth_token: []
      operationId: addPolicyACLTemplate
      tags:
        - policies
      description: '**Required ACL:** `auth.policies.{policy_uuid}.edit`'
      summary: Associate an ACL template to a policy
      parameters:
      - $ref: '#/parameters/policy_uuid'
      - name: acl_template
        in: path
        type: string
        description: The ACL template to add
        required: true
      responses:
        '204':
          description: The policy has been modified
        '404':
          description: Policy not found
          schema:
            $ref: '#/definitions/Error'
  /tenants:
    get:
      tags:
        - tenants
      security:
        - wazo_auth_token: []
      description: '**Required ACL**: `auth.tenants.read`'
      summary: 'Retrieves the list of tenants'
      parameters:
      - $ref: '#/parameters/order'
      - $ref: '#/parameters/direction'
      - $ref: '#/parameters/limit'
      - $ref: '#/parameters/offset'
      - $ref: '#/parameters/search'
      responses:
        '200':
          description: 'The list of tenant'
          schema:
            $ref: '#/definitions/TenantList'
    post:
      consumes:
      - application/json
      produces:
      - application/json
      summary: Creates a new tenant
      description: '**Required ACL:** `auth.tenants.create'
      operationId: createTenant
      tags:
      - tenants
      security:
      - wazo_auth_token: []
      parameters:
        - name: body
          in: body
          description: The tenant creation parameters
          required: true
          schema:
            $ref: '#/definitions/TenantCreate'
      responses:
        '200':
          description: The new tenant
          schema:
            $ref: '#/definitions/TenantPostResponse'
        '400':
          description: Invalid body
          schema:
            $ref: '#/definitions/APIError'
  /tenants/{tenant_uuid}:
    delete:
      operationId: delete_tenant
      tags:
        - tenants
      security:
      - wazo_auth_token: []
      description: '**Required ACL**: `auth.tenants.{tenant_uuid}.delete`'
      parameters:
      - $ref: '#/parameters/tenant_uuid'
      summary: Delete a tenant
      responses:
        '204':
          description: The tenant has been removed
        '401':
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        '404':
          description: Tenant not found
          schema:
            $ref: '#/definitions/Error'
        '500':
          description: System related error
          schema:
            $ref: '#/definitions/Error'
    get:
      tags:
        - tenants
      security:
      - wazo_auth_token: []
      description: '**Required ACL**: `auth.tenants.{tenant_uuid}.read`'
      parameters:
      - $ref: '#/parameters/tenant_uuid'
      summary: Retrieves the details of a tenant
      responses:
        '200':
          description: "The tenant's data"
          schema:
            $ref: '#/definitions/TenantResult'
        '401':
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        '404':
          description: Tenant not found
          schema:
            $ref: '#/definitions/Error'
        '500':
          description: System related error
          schema:
            $ref: '#/definitions/Error'
  /tenants/{tenant_uuid}/users:
    get:
      tags:
        - tenants
      security:
      - wazo_auth_token: []
      description: '**Required ACL**: `auth.tenants.{tenant_uuid}.users.read`'
      parameters:
      - $ref: '#/parameters/order'
      - $ref: '#/parameters/direction'
      - $ref: '#/parameters/limit'
      - $ref: '#/parameters/offset'
      - $ref: '#/parameters/search'
      - $ref: '#/parameters/tenant_uuid'
      summary: Retrieves the details of a tenant
      responses:
        '200':
          description: "The tenant's data"
          schema:
            $ref: '#/definitions/UserList'
        '401':
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        '404':
          description: Tenant not found
          schema:
            $ref: '#/definitions/Error'
        '500':
          description: System related error
          schema:
            $ref: '#/definitions/Error'
  /tenants/{tenant_uuid}/users/{user_uuid}:
    put:
      tags:
        - users
        - tenants
      security:
        - wazo_auth_token: []
      operationId: addUserTenant
      description: '**Required ACL:** `auth.tenants.{tenant_uuid}.users.{user_uuid}.create`'
      summary: Associate a user to a tenant
      parameters:
      - $ref: '#/parameters/tenant_uuid'
      - $ref: '#/parameters/user_uuid'
      responses:
        '204':
          description: Association successful
        '404':
          description: User or Tenant not found
          schema:
            $ref: '#/definitions/Error'
    delete:
      tags:
        - users
        - tenants
      security:
        - wazo_auth_token: []
      operationId: removeUserTenant
      description: '**Required ACL:** `auth.tenants.{tenant_uuid}.users.{user_uuid}.delete`'
      summary: Dissociate a tenant and a user
      parameters:
      - $ref: '#/parameters/tenant_uuid'
      - $ref: '#/parameters/user_uuid'
      responses:
        '204':
          description: The association has been removed
        '404':
          description: User or Tenant not found
          schema:
            $ref: '#/definitions/Error'
  /token:
    post:
      consumes:
      - application/json
      produces:
      - application/json
      summary: Creates a token
      description: 'Creates a valid token for the supplied username and password combination
        using the specified backend. The stock backends are: ``xivo_user``, ``xivo_service``,
        ``xivo_admin``, ``ldap_user``. For more details about the backends, see http://documentation.wazo.community/en/latest/system/wazo-auth/stock_plugins.html#backends-plugins'
      operationId: createToken
      tags:
      - token
      security:
      - wazo_auth_basic: []
      parameters:
      - name: body
        in: body
        description: The token creation parameters
        required: true
        schema:
          type: object
          properties:
            backend:
              type: string
            expiration:
              type: integer
          required:
          - backend
      responses:
        '200':
          description: The created token's data
          schema:
            $ref: '#/definitions/Token'
        '400':
          description: Invalid expiration
          schema:
            $ref: '#/definitions/Error'
        '500':
          description: System related token generation error
          schema:
            $ref: '#/definitions/Error'
  /token/{token}:
    get:
      tags:
      - token
      security:
      - {}
      parameters:
      - name: token
        in: path
        type: string
        description: The token to query
        required: true
      - name: scope
        in: query
        type: string
        description: The required ACL
        required: false
      summary: Retrieves token data
      responses:
        '200':
          description: The token's data
          schema:
            $ref: '#/definitions/Token'
        '403':
          description: This token cannot acces the required ACL
          schema:
            $ref: '#/definitions/Error'
        '404':
          description: Token not found
          schema:
            $ref: '#/definitions/Error'
        '500':
          description: System related token error
          schema:
            $ref: '#/definitions/Error'
    head:
      tags:
      - token
      security:
      - {}
      parameters:
      - name: token
        in: path
        type: string
        description: The token to query
        required: true
      - name: scope
        in: query
        type: string
        description: The required ACL
        required: false
      summary: Checks if a token is valid
      responses:
        '204':
          description: No data
        '403':
          description: This token cannot acces the required ACL
          schema:
            $ref: '#/definitions/Error'
        '404':
          description: Token not found
          schema:
            $ref: '#/definitions/Error'
        '500':
          description: System related token error
          schema:
            $ref: '#/definitions/Error'
    delete:
      tags:
      - token
      security:
      - {}
      parameters:
      - name: token
        in: path
        type: string
        description: The token to query
        required: true
      summary: Revoke a token
      responses:
        '200':
          description: Success message
        '500':
          description: System related token error
          schema:
            $ref: '#/definitions/Error'
  /users:
    get:
      tags:
        - users
      security:
        - wazo_auth_token: []
      description: '**Required ACL**: `auth.users.read`'
      summary: 'Retrieves the list of users'
      parameters:
      - $ref: '#/parameters/order'
      - $ref: '#/parameters/direction'
      - $ref: '#/parameters/limit'
      - $ref: '#/parameters/offset'
      - $ref: '#/parameters/search'
      responses:
        '200':
          description: 'The list of user'
          schema:
            $ref: '#/definitions/UserList'
    post:
      consumes:
        - application/json
      produces:
        - application/json
      summary: Create a user
      description: "Creates a new user that can be used to retrieve a token. The new user privilege
        are limited until its email address has been confirmed"
      operationId: createUser
      tags:
        - users
      parameters:
        - name: body
          in: body
          description: The user creation parameters
          required: true
          schema:
            $ref: '#/definitions/UserCreate'
      responses:
        '200':
          description: The new user data without the password
          schema:
            $ref: '#/definitions/UserPostResponse'
        '400':
          description: Invalid body
          schema:
            $ref: '#/definitions/APIError'
  /users/{user_uuid}:
    get:
      tags:
        - users
      security:
      - wazo_auth_token: []
      description: '**Required ACL**: `auth.users.{user_uuid}.read`'
      parameters:
      - $ref: '#/parameters/user_uuid'
      summary: Retrieves the details of a user
      responses:
        '200':
          description: "The user's data"
          schema:
            $ref: '#/definitions/UserResult'
        '401':
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        '404':
          description: User not found
          schema:
            $ref: '#/definitions/Error'
        '500':
          description: System related error
          schema:
            $ref: '#/definitions/Error'
    delete:
      operationId: delete_user
      tags:
        - users
      security:
      - wazo_auth_token: []
      description: '**Required ACL**: `auth.users.{user_uuid}.delete`'
      parameters:
      - $ref: '#/parameters/user_uuid'
      summary: Delete a user
      responses:
        '204':
          description: The user has been removed
        '401':
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        '404':
          description: not found
          schema:
            $ref: '#/definitions/Error'
        '500':
          description: System related error
          schema:
            $ref: '#/definitions/Error'
  /users/{user_uuid}/tenants:
    get:
      tags:
        - users
      security:
      - wazo_auth_token: []
      description: '**Required ACL**: `auth.users.{user_uuid}.tenants.read`'
      parameters:
      - $ref: '#/parameters/order'
      - $ref: '#/parameters/direction'
      - $ref: '#/parameters/limit'
      - $ref: '#/parameters/offset'
      - $ref: '#/parameters/search'
      - $ref: '#/parameters/user_uuid'
      summary: Retrieves the details of a user
      responses:
        '200':
          description: "The user's tenant list"
          schema:
            $ref: '#/definitions/TenantList'
        '401':
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        '404':
          description: User not found
          schema:
            $ref: '#/definitions/Error'
        '500':
          description: System related error
          schema:
            $ref: '#/definitions/Error'
  /users/{user_uuid}/policies:
    get:
      tags:
        - users
        - policies
      security:
      - wazo_auth_token: []
      description: '**Required ACL**: `auth.users.{user_uuid}.policies.read`'
      parameters:
      - $ref: '#/parameters/user_uuid'
      - $ref: '#/parameters/order'
      - $ref: '#/parameters/direction'
      - $ref: '#/parameters/limit'
      - $ref: '#/parameters/offset'
      - $ref: '#/parameters/search'
      summary: Retrieves the list of policies associated to a user
      responses:
        '200':
          description: "The user's policies"
          schema:
            $ref: '#/definitions/GetPoliciesResult'
        '401':
          description: Unauthorized
          schema:
            $ref: '#/definitions/Error'
        '404':
          description: User not found
          schema:
            $ref: '#/definitions/Error'
        '500':
          description: System related error
          schema:
            $ref: '#/definitions/Error'
  /users/{user_uuid}/policies/{policy_uuid}:
    put:
      tags:
        - users
        - policies
      security:
        - wazo_auth_token: []
      operationId: addUserPolicy
      description: '**Required ACL:** `auth.users.{user_uuid}.policies.{policy_uuid}.create`'
      summary: Associate a policy to a user
      parameters:
      - $ref: '#/parameters/policy_uuid'
      - $ref: '#/parameters/user_uuid'
      responses:
        '204':
          description: The policy has been assigned
        '404':
          description: User or Policy not found
          schema:
            $ref: '#/definitions/Error'
    delete:
      tags:
        - users
        - policies
      security:
        - wazo_auth_token: []
      operationId: removeUserPolicy
      description: '**Required ACL:** `auth.users.{user_uuid}.policies.{policy_uuid}.delete`'
      summary: Dissociate a policy from a user
      parameters:
      - $ref: '#/parameters/policy_uuid'
      - $ref: '#/parameters/user_uuid'
      responses:
        '204':
          description: The policy has been unassigned
        '404':
          description: User or Policy not found
          schema:
            $ref: '#/definitions/Error'
  /backends:
    get:
      tags:
      - backends
      security:
      - {}
      description: Retrieves the list of activated backends
      responses:
        '200':
          description: The list of activated backends
          schema:
            $ref: '#/definitions/BackendList'
parameters:
  direction:
    required: false
    name: direction
    in: query
    type: string
    enum:
    - asc
    - desc
    description: Sort list of items in 'asc' (ascending) or 'desc' (descending) order
  limit:
    name: limit
    in: query
    type: integer
    description: The limit defines the number of individual objects that are returned
    required: false
  offset:
    name: offset
    in: query
    type: integer
    description: The offset defines the offsets the start by the number specified
    default: 0
    required: false
  order:
    required: false
    name: order
    in: query
    type: string
    description: Name of the field to use for sorting the list of items returned.
  policy_uuid:
    name: policy_uuid
    in: path
    type: string
    description: The UUID of the policy
    required: true
  tenant_uuid:
    name: tenant_uuid
    in: path
    type: string
    description: The UUID of the tenant
    required: true
  user_uuid:
    name: user_uuid
    in: path
    type: string
    description: The UUID of the user
    required: true
  search:
    required: false
    name: search
    in: query
    type: string
    description: Search term for filtering a list of items. Only items with a field
      containing the search term will be returned.
definitions:
  APIError:
    type: object
    properties:
      timestamp:
        type: number
      message:
        type: string
      resource:
        type: string
      details:
        type: object
  BackendList:
    type: object
    properties:
      data:
        type: array
        items:
          type: string
  Policy:
    type: object
    properties:
      name:
        type: string
      description:
        type: string
      acl_templates:
        type: array
        items:
          type: string
  PolicyResult:
    type: object
    properties:
      uuid:
        type: string
      name:
        type: string
      description:
        type: string
      acl_templates:
        type: array
        items:
          type: string
    required:
    - uuid
    - name
    - description
    - acl_templates
  GetPoliciesResult:
    type: object
    properties:
      total:
        type: integer
        description: The number of policies matching the searched term
      items:
        type: array
        items:
          $ref: '#/definitions/PolicyResult'
        description: A paginated list of policies
    required:
    - total
    - items
  TenantPostResponse:
    type: object
    properties:
      name:
        type: string
      uuid:
        type: string
  UserEmail:
    type: object
    properties:
      address:
        type: string
      main:
        type: boolean
      confirmed:
        type: boolean
  UserPostResponse:
    type: object
    properties:
      username:
        type: string
      emails:
        type: array
        items:
          $ref: '#/definitions/UserEmail'
      uuid:
        type: string
  TenantList:
    type: object
    properties:
      total:
        type: integer
        description: The number of tenants
      filtered:
        type: integer
        description: The number of tenants matching the searched term
      items:
        type: array
        items:
          $ref: '#/definitions/TenantResult'
        description: A paginated list of tenants
  UserList:
    type: object
    properties:
      total:
        type: integer
        description: The number of users
      filtered:
        type: integer
        description: The number of users matching the searched term
      items:
        type: array
        items:
          $ref: '#/definitions/UserResult'
        description: A paginated list of users
  TenantResult:
    type: object
    properties:
      uuid:
        type: string
      name:
        type: string
  UserResult:
    type: object
    properties:
      uuid:
        type: string
      username:
        type: string
      main_email_address:
        type: string
  UserCreate:
    type: object
    properties:
      username:
        type: string
        description: The username that will identify that new username
      password:
        type: string
        description: The password of the newly created username
      email_address:
        type: string
        description: The main email address of the new username
    required:
      - username
      - password
      - email_address
  TenantCreate:
    type: object
    properties:
      name:
        type: string
        description: "The tenant's name"
    required:
      - name
  Token:
    type: object
    properties:
      data:
        type: object
        properties:
          token:
            type: string
          expires_at:
            type: string
          utc_expires_at:
            type: string
          issued_at:
            type: string
          utc_issued_at:
            type: string
          auth_id:
            type: string
            description: The unique identifier retrieved from the backend
          xivo_user_uuid:
            type: string
            description: The UUID of the Wazo user matching these credentials, this
              field can be None
          xivo_uuid:
            type: string
          acls:
            type: array
            items:
              type: string
            description: The list of allowed ACLs for this token
  Error:
    type: object
    properties:
      reason:
        type: array
        items:
          type: string
      timestamp:
        type: array
        items:
          type: string
      status_code:
        type: integer
